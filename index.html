<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roundism MedTracker (Renewed)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- ROUNDISM STYLES --- */
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f2f4f8;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            color: #1a1a1a;
            min-height: 100vh;
            padding-bottom: 100px;
        }
        .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .glass-dark {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .glass-red {
            background: rgba(254, 226, 226, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(252, 165, 165, 0.5);
        }
        .round-check {
            appearance: none;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #cbd5e1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            cursor: pointer;
            background-color: white;
        }
        .round-check:checked {
            background-color: #10b981;
            border-color: #10b981;
            transform: scale(1.1);
        }
        .round-check:checked::after {
            content: '‚úì';
            position: absolute;
            color: white;
            font-size: 1.2rem;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .card-enter {
            animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        /* Tags */
        .tag-BP { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .tag-Sugar { background-color: #fce7f3; color: #9d174d; border: 1px solid #f9a8d4; }
        .tag-Stomach { background-color: #ffedd5; color: #9a3412; border: 1px solid #fdba74; }
        .tag-Pain { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .tag-Heart { background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        
        /* Spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="selection:bg-indigo-500 selection:text-white">

    <div class="max-w-2xl mx-auto px-4 py-8">
        
        <header class="text-center mb-8 text-white">
            <h1 class="text-4xl font-extrabold tracking-tight mb-2">Daily Meds</h1>
            <p class="opacity-80 text-lg font-medium">Synced Cloud Tracker</p>
            
            <div class="flex flex-col items-center gap-3 mt-4">
                <div id="date-display" class="glass-dark px-6 py-2 rounded-full text-sm font-semibold tracking-wide"></div>
                <div id="sync-status" class="px-3 py-1 rounded-full text-[10px] font-mono tracking-wider bg-white/10 border border-white/20 text-gray-300 flex items-center gap-2">
                    <div class="spinner"></div> Connecting...
                </div>
            </div>
        </header>

        <div id="loading-screen" class="glass p-8 rounded-3xl text-center mb-8">
            <p class="text-gray-500 font-medium">Syncing with database...</p>
        </div>

        <div id="main-content" class="hidden">
            
            <div id="sos-container" class="mb-10 space-y-4">
                <div class="flex items-center gap-2 px-2 mb-2">
                     <span class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">SOS / Conditional</span>
                </div>
                </div>

            <section id="morning-section" class="mb-12">
                <div class="flex items-center gap-3 mb-6 px-2">
                    <div class="p-2 bg-orange-100 rounded-full text-orange-600"><i data-lucide="sun" class="w-6 h-6"></i></div>
                    <h2 class="text-2xl font-bold text-white">Morning Routine</h2>
                </div>
                <div class="space-y-4" id="morning-list"></div>
            </section>

            <section id="night-section" class="mb-20">
                <div class="flex items-center gap-3 mb-6 px-2">
                    <div class="p-2 bg-indigo-100 rounded-full text-indigo-600"><i data-lucide="moon" class="w-6 h-6"></i></div>
                    <h2 class="text-2xl font-bold text-white">Night Routine</h2>
                </div>
                <div class="space-y-4" id="night-list"></div>
            </section>
        </div>

    </div>

    <script>
        // --- 1. SETUP MEDICINES ---
        
        // SOS / Conditional Medicines (Static list, not tracked daily)
        const SOS_MEDICINES = [
            { 
                name: 'Angised 0.5mg', 
                image: 'Angised_resized.png', 
                desc: 'Used for immediate relief of chest pain.', 
                tag: 'Pain',
                trigger: 'In case of Chest Pain'
            },
            { 
                name: 'Lopec 50mg', 
                image: 'Lopec_resized.png', 
                desc: 'Taken only if Blood Pressure is extremely high.', 
                tag: 'BP',
                trigger: 'Conditional Evening'
            }
        ];

        // Routine Medicines (Tracked in Database)
        const MEDICINES = [
            { id: 'zopent', name: 'Zopent 40mg', image: 'zopent_resized.webp', daysTotal: 30, schedule: ['morning'], instruction: 'Before Breakfast', desc: 'Reduces stomach acid.', tags: ['Stomach'] },
            { id: 'lowplat', name: 'Lowplat Plus 75mg', image: 'Lowplat_resized.png', daysTotal: 30, schedule: ['morning'], instruction: 'After Food', desc: 'Blood thinner/Antiplatelet for heart health.', tags: ['Heart'] },
            { id: 'cardnit', name: 'Cardnit 6.4mg', image: 'Cardnit_resized.webp', daysTotal: 30, schedule: ['morning', 'night'], instruction: 'After Food', desc: 'Prevents angina (chest pain).', tags: ['Pain'] },
            { id: 'ranola', name: 'Ranola 500mg', image: 'Ranola_resized.png', daysTotal: 30, schedule: ['morning', 'night'], instruction: 'After Food', desc: 'Treats chronic chest pain.', tags: ['Heart'] },
            { id: 'anplag', name: 'Anplag 90mg', image: 'Anplag_resized.webp', daysTotal: 30, schedule: ['morning', 'night'], instruction: 'After Food', desc: 'Prevents blood clots.', tags: ['Heart'] },
            { id: 'carsel', name: 'Carsel 50mg', image: 'Carsel 50mg_resized.webp', daysTotal: 30, schedule: ['morning', 'night'], instruction: 'After Food', desc: 'Beta-blocker for BP and heart rate.', tags: ['BP'] },
            { id: 'dapa', name: 'Dapa-Met XR 10/1000', image: 'DapaMet XR_resized.jpg', daysTotal: 30, schedule: ['morning', 'night'], instruction: 'After Food', desc: 'Diabetes sugar control.', tags: ['Sugar'] },
            { id: 'loprin', name: 'Loprin 75mg', image: 'Loprin_resized.webp', daysTotal: 30, schedule: ['night'], instruction: 'After Food', desc: 'Blood thinner.', tags: ['Heart'] },
            { id: 'rolip', name: 'RolipEze 20/10mg', image: 'RolipEze_resized.webp', daysTotal: 30, schedule: ['night'], instruction: 'After Food', desc: 'Cholesterol management.', tags: ['Heart'] }
        ];

        // --- 2. SUPABASE CONFIG ---
        const PROJECT_ID = 'ryqwceszztarmxqmgjqn';
        const SUPABASE_URL = `https://${PROJECT_ID}.supabase.co`;
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5cXdjZXN6enRhcm14cW1nanFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMTMzNDcsImV4cCI6MjA4MzY4OTM0N30.52kKJehxwXAeGb-YO0eUQBuUgm9hXZ7_jJiVjLNksMc';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let dbState = {}; // Local copy of DB data

        // --- 3. LOGIC ---
        
        async function initApp() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('date-display').innerText = new Date().toLocaleDateString('en-US', options);

            renderSOS(); // Render static SOS cards immediately

            try {
                // Fetch existing data
                const { data, error } = await supabaseClient.from('medicine_tracking').select('*');
                if (error) throw error;

                // Check for missing medicines in DB (New list items)
                await ensureMedicinesExistInDB(data);

                // Re-fetch after seeding if necessary
                const { data: refreshedData } = await supabaseClient.from('medicine_tracking').select('*');
                processDBData(refreshedData);

            } catch (err) {
                console.error("DB Error:", err);
                document.getElementById('sync-status').innerText = "‚ö†Ô∏è Sync Error";
                document.getElementById('sync-status').className = "px-3 py-1 rounded-full text-xs font-bold bg-red-500 text-white";
            }
        }

        async function ensureMedicinesExistInDB(existingData) {
            const existingIds = new Set(existingData.map(d => d.id));
            const updates = [];
            const today = new Date();

            MEDICINES.forEach(med => {
                if (!existingIds.has(med.id)) {
                    console.log(`Seeding missing med: ${med.id}`);
                    updates.push({
                        id: med.id,
                        start_date: today.toDateString(),
                        last_check_date: today.toDateString(),
                        morning_check: false,
                        night_check: false
                    });
                }
            });

            if (updates.length > 0) {
                const { error } = await supabaseClient.from('medicine_tracking').insert(updates);
                if (error) console.error("Seeding failed", error);
            }
        }

        function processDBData(rows) {
            const todayStr = new Date().toDateString();
            rows.forEach(row => {
                if (row.last_check_date !== todayStr) {
                    resetChecksForMed(row.id, todayStr);
                    row.morning_check = false;
                    row.night_check = false;
                }
                dbState[row.id] = row;
            });
            renderRoutineUI();
            
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('sync-status').innerHTML = 'üü¢ Synced Online';
            document.getElementById('sync-status').className = "px-3 py-1 rounded-full text-[10px] font-bold bg-green-500/20 text-green-300 border border-green-500/50";
        }

        async function toggleMed(id, time) {
            const isMorning = time === 'morning';
            if (!dbState[id]) return;

            const currentVal = isMorning ? dbState[id].morning_check : dbState[id].night_check;
            const newVal = !currentVal;

            if (isMorning) dbState[id].morning_check = newVal;
            else dbState[id].night_check = newVal;
            
            renderRoutineUI(); 

            const updateObj = isMorning ? { morning_check: newVal } : { night_check: newVal };
            updateObj.last_check_date = new Date().toDateString(); 

            const { error } = await supabaseClient.from('medicine_tracking').update(updateObj).eq('id', id);
            
            if (error) {
                console.error("Sync failed", error);
                // Revert UI on failure
                if (isMorning) dbState[id].morning_check = !newVal;
                else dbState[id].night_check = !newVal;
                renderRoutineUI();
            } else {
                if(newVal) triggerConfetti();
            }
        }

        async function resetChecksForMed(id, todayStr) {
            await supabaseClient.from('medicine_tracking').update({
                last_check_date: todayStr,
                morning_check: false,
                night_check: false
            }).eq('id', id);
        }

        function getDayCount(medId) {
            if (!dbState[medId]) return 1;
            const start = new Date(dbState[medId].start_date);
            const now = new Date();
            const diffTime = Math.floor((now - start) / (1000 * 60 * 60 * 24));
            return Math.max(1, diffTime + 1); 
        }

        // --- 4. RENDER UI ---

        function renderSOS() {
            const container = document.getElementById('sos-container');
            // Keep header, clear cards
            container.innerHTML = `
                <div class="flex items-center gap-2 px-2 mb-2">
                     <span class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">SOS / Conditional</span>
                </div>
            `;

            SOS_MEDICINES.forEach((med, index) => {
                const div = document.createElement('div');
                div.className = "glass-red border-l-8 border-l-red-500 rounded-3xl p-6 shadow-xl relative overflow-hidden card-enter mb-4";
                div.style.animationDelay = `${index * 0.1}s`;
                div.innerHTML = `
                    <div class="absolute -right-6 -top-6 bg-red-200 w-24 h-24 rounded-full opacity-50 blur-2xl"></div>
                    <div class="flex items-start gap-4">
                        <div class="w-16 h-16 shrink-0 rounded-2xl bg-white p-2 shadow-inner flex items-center justify-center">
                            <img src="${med.image}" alt="${med.name}" class="w-full h-full object-contain" onerror="this.src='https://via.placeholder.com/64?text=Meds'">
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                <h2 class="text-xl font-bold text-gray-800">${med.name}</h2>
                                <span class="tag-${med.tag} px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wide">${med.tag}</span>
                            </div>
                            <p class="text-gray-700 font-bold text-xs uppercase mb-1 text-red-700">‚ö†Ô∏è ${med.trigger}</p>
                            <p class="text-gray-600 font-medium text-sm leading-relaxed">${med.desc}</p>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderRoutineUI() {
            const morningContainer = document.getElementById('morning-list');
            const nightContainer = document.getElementById('night-list');
            morningContainer.innerHTML = '';
            nightContainer.innerHTML = '';

            let delay = 0;

            MEDICINES.forEach(med => {
                // Safety check: if DB record doesn't exist yet, skip render until synced
                if (!dbState[med.id]) return;

                const currentDay = getDayCount(med.id);
                
                med.schedule.forEach(time => {
                    const isMorning = time === 'morning';
                    const container = isMorning ? morningContainer : nightContainer;
                    
                    const isChecked = isMorning ? dbState[med.id].morning_check : dbState[med.id].night_check;
                    
                    delay++;

                    // Tags
                    const tagsHtml = med.tags.map(tag => 
                        `<span class="tag-${tag} px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wide ml-2 align-middle">${tag}</span>`
                    ).join('');

                    const card = document.createElement('div');
                    card.className = `glass rounded-[2rem] p-5 flex items-start gap-4 shadow-sm hover:shadow-md transition-all duration-300 card-enter border border-white/60`;
                    card.style.animationDelay = `${delay * 0.05}s`;

                    card.innerHTML = `
                        <div class="w-16 h-16 shrink-0 bg-white rounded-2xl p-2 shadow-inner flex items-center justify-center mt-1">
                            <img src="${med.image}" class="w-full h-full object-contain" alt="${med.name}" onerror="this.src='https://via.placeholder.com/64?text=Meds'">
                        </div>
                        <div class="flex-grow">
                            <div class="flex flex-wrap items-center mb-1">
                                <h3 class="text-lg font-bold text-gray-800 leading-tight">${med.name}</h3>
                                ${tagsHtml}
                            </div>
                            <p class="text-xs text-gray-500 mb-2 leading-relaxed pr-2">${med.desc}</p>
                            <p class="text-sm text-gray-700 font-bold mb-2">
                                <span class="text-indigo-500">‚óè</span> ${med.instruction}
                            </p>
                            <div class="flex items-center gap-2">
                                <span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold">
                                    Day ${currentDay}
                                </span>
                            </div>
                        </div>
                        <div class="shrink-0 pr-1 pt-2">
                            <input type="checkbox" class="round-check" ${isChecked ? 'checked' : ''} onchange="toggleMed('${med.id}', '${time}')">
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
            lucide.createIcons();
        }

        function triggerConfetti() {
            confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 }, colors: ['#34d399', '#60a5fa'] });
        }

        // Start
        initApp();

    </script>
</body>
</html>
